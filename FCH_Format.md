# FCH File Format

The following data types have been observed:
- *u8* - 1-byte value, occasionally seen for booleans
- *i32* - 4 byte integers are stored in little-endian
- *i64* - 8 byte integers stored in little-endian. Used for Player IDs
- *float* - 4 byte floating point value
- *string* - A u8 length followed by the string data (excluding a NUL-terminator)

The FCH format is sort of an amorphis stream that can change at any point.

The file is split into two segments:
1. File Data
2. Checksum

There is an i32 byte count prefixing each:
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Data Size | Number of bytes in the data segment |
| u8[DataSize] | Data Bytes | The data |
| i32 | Checksum size |  Number of bytes in the checksum segment |
| u8[ChecksumSize] | Checksum Bytes | SHA-512 Checksum value of the data segment |

The Data Segment is further broken up into several chunks:
1. Player Statistics
2. World Data
3. Player Data

Each of these is detailed below.

Note:
- The checksum doesn't appear to be validated, it's just there.

# Chunk 1: Player Statistics

This chunk also contains the player version. At the time of writing, the player version is 33.

| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Version | Player Version (33) |
| i32 | Kills | Number of kills |
| i32 | Deaths | Number of deaths |
| i32 | Crafts | Number of items crafter |
| i32 | Builds | Number of structures built |

Notes:
- The Kills, Deaths, Crafts, and Builds fields were introduced in Player Version 28

# Chunk 2: World Data

The world data starts with a count. A character that has yet to load into any worlds has a count of 0.

| Type | Name | Description |
| ---- | ---- | ----------- |
| i32  | Count | Number of minimaps stored in the file |

Each world in the segment has a header, visibility data, and a list of map markers

## World Header

| Type | Name | Description |
| ---- | ---- | ----------- |
| i64 | UID | World ID |
| u8 | HaveSpawnPoint | Boolean: 1 if there's a custom spawn point; 0 otherwise |
| float[3] | SpawnPoint | World Spawn point. (X,Y,Z) Note: Only present if HaveSpawnPoint is True |
| u8 | HaveLogoutPoint | Boolean: 1 if there's a logout point; 0 otherwise |
| float[3] LogoutPoint | World logout point. (X,Y,Z) Note: Only present if HaveLogoutPoint is True |
| u8 | HaveDeathPoint | Boolean: 1 if there's a last death point; 0 otherwise |
| float[3] | DeathPoint | Last death location. (X,Y,Z) Note: Only present if HaveDeathPoint is True |
| float[3] | HomePoint | Player's home location (X,Y,Z). Always present |
| u8 | HaveVisibilityData | If the world visibility data is included |

Notes:
- The HaveDeathPoint and DeathPoint fields were added in PlayerVersion 30
- The HaveVisibilityData field and the world visibility data were added in PlayerVersion 29

## World Visibility

The visibility section starts with an Edge Length. Squaring this value gives the number of bytes used by the visibility data.

Each byte has one of two values:
- 0: hidden/fog
- 1: visible

The visibility data is stored as a series of EdgeLength rows with EdgeLength columns each.
The first row represents the bottom of the minimap, as seen on screen.
Thus the rows are numbered: [EdgeLen-1, 0]

| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Version | Minimap version data (4) |
| i32 | EdgeLen | Number of bytes for each edge of the minimap |
| u8[EdgeLen*EdgeLen] | Visibility | Minimap visibility data |
| i32 | MapMarkerCount | Number of map markers available |
| u8[...] | MapMarkerList | Map Marker Data (see subsection) |
| u8 | PublicPosition | Boolean: If position is broadcast publically on the minimap |

Notes:
- It looks like this chunk was added in file version 29?
- PublicPosition was added in minimap version 4, file version 33

### Minimap Markers (MapMarkerList)

A list of the markers (mostly player-defined) on the minimap.
A i32 count preceeds the marker entries.

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Count | Number of minimap markers in the list |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Text | Marker text |
| float[3] | Location | (X,Y,Z) coordinates of the marker's location |
| i32 | Symbol | Which symbol is used (see below) |
| u8 | Strike | Boolean, if True: the symbol is Xed out |

*Known Symbol Values:*
- 0x00: Campfire
- 0x01: House
- 0x02: The T thing
- 0x03: Dot
- 0x04: Gate/Portal
- 0x09: Boss marker

Notes:
- There's no logical reason for the Location to be (X,Y,Z) when (X,Y) should be sufficient...
- Oddly enough, the Z coordinate is used in place of Y for the marker position. Only Boss locations seem to set Y. My assumption is that they're using 3D coordinates mapped to a 2D plain, so (X,Z) are the map plain, with Y being height. The reason Y is set for Boss locations is that they're generated by the game and thus the true physical coordinates of the boss alter and not a sketchily placed marker from the player.

## Chunk 3: Player Data

The player data is pretty extensive and is broken up into several sections.

### Header

| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Name | Player name |
| i64 | ID | Player ID number |
| u8 | StartSeedLen | Length (in bytes) of the start seed |
| u8[StartSeedLen] | StartSeed | Starting seed, whatever this means |
| u8 | HavePlayerData | Boolean, 1 if there's player data, 0 otherwise |

Note: If HavePlayerData is False, then the remaining fields in this chunk do not exist.

### Player Data (2)

| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Version | Player data version (24) |
| float | MaxHealth | Current maximum health (dependent on food, etc.) |
| float | Health | Current health |
| float | MaxStamina | Current maximum stamina (dependent on food, etc.) |
| u8 | FirstSpawn | True (1) if this would be the characters first spawn into any world. 0 otherwise |
| float | TimeSinceDeath | How long the player has been alive |
| string | GuardianPowerName | Which guardian power is active (if any) |
| float | GuardianPowerCooldown | Time remaining before the guardian power can be used again |

Notes:
- MaxStamina was introduced in Version 10
- FirstSpawn was introduced in Version 8
- TimeSinceDeath was introduced in Version 20
- GuardianPowerName was introduced in Version 23
- GuardianPowerCooldown was introduced in Version 24

### Inventory

Cautions:
- Inventory item names are the keys used in-game, so the must be correct
- Ensure all items are in unique slots (Row, Column) pairs
- Ensure all items are in valid slots (Row: 0-3, Column: 0-7)

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Version | Inventory data version (103) |
| i32 | Count | Number of inventory items |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Name | Item name/type |
| i32 | Count | Stack count. Always 1 for equipment |
| float | Durability | Item Durability. Always 100.0 for non-equips. Often > 100 for equips. |
| int[2] | Slot | Item slot (X,Y). X range: [0,7]; Y range: [0,3] |
| u8 | Equipped | Boolean: 1 if item is equipped, 0 otherwise |
| i32 | Level | Item level. Always 1 for non-equips |
| i32 | Style | Paint style. Only used for shields, always 0 for non-shields |
| i64 | CrafterID | ID of the player who crafted the item |
| string | CrafterName | Name of the player who crafted the item |

Notes:
- Level was added in Inventory Version 101
- Style was added in Inventory Version 102
- CrafterID and CrafterName were added in InventoryVersion 103

### Known Recipes

Recipes you've discovered.

This is just a string table. It starts with a i32 count followed by a series of string entries.

### Crafting Stations

Highest level discovered/built for the upgradable crafting stations:
- Workbench
- Forge
- Cauldron

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Count | Number of entries in this list |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Name | Station name |
| i32 | Level | Highest level |

### Discovered Materials

Materials you've discovered (picked up).

This is just a string table. It starts with a i32 count followed by a series of string entries.

### Shown Tutorials

Names of the tutorials you've interacted with.

This is just a string table. It starts with a i32 count followed by a series of string entries.

### Discovered Uniques

Unique items you've discovered (picked up).

This is just a string table. It starts with a i32 count followed by a series of string entries.

### Trophies

List of trophies you've picked up.

This is just a string table. It starts with a i32 count followed by a series of string entries.

### Known Biomes

Which biomes you've discovered.

This is an i32 count followed by the i32 ID of each biome.

The biome IDs appear to be single bits.

*Known Biomes*
- 1 = Meadows
- 2 = Swamp
- 4 = Mountains
- 8 = Black Forest
- 16 = Plains
- 32 = Ashlands
- 64 = Deep North
- 256 = Ocean
- 512 = Mistlands

### Journal

List of journal entries.

This is a fancier string table, each entry is two strings each.

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Count | Number of entries in this list |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Label | Name of the label variable |
| string | Text | Name of the text variable |

### Appearance

Notes:
- c1, c2, and c3 always seem to be the same value?

| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Beard | Beard type name |
| string | Hair | Hair type name |
| float[3] | Complexion | Skin Color/Complexion. Looks like RGB, not HSV |
| float[3] | HairColor | Hair Color/Blondness. Looks like RGB, not HSV |
| i32 | BodyType | 0 for the male body, 1 for the female body |

### Active Food

Eaten/Active food.

Notes:
- The count likely caps at 3, though I haven't tested

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Count | Number of entries in this list |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| string | Name | Food name |
| float | Health | Remaining given health for this item |
| float | Stamina | Remaining given stamina for this item |

Note:
- The Health and Stamina values get smaller over time

### Skills

Skill data.

*Header:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Version | Skills block version number |
| i32 | Count | Number of entries in this list |

*Entries:*
| Type | Name | Description |
| ---- | ---- | ----------- |
| i32 | Type | Skill type/ID, see below |
| float | Level | Can be fractional. But it's all just the level! |
| float | Experience | Accumulated experience |

Notes:
- The Experience field was added in Skills Version 2.

*Known Skill Types:*
- 0x01: Sword
- 0x02: Knives
- 0x03: Clubs
- 0x04: Polearms
- 0x05: Spears
- 0x06: Blocking
- 0x07: Axes
- 0x08: Bows
- 0x09: FireMagic
- 0x0a: FrostMagic
- 0x0b: Unarmed
- 0x0c: Pickaxes
- 0x0d: Woodcutting
- 0x64: Jump
- 0x65: Sneak
- 0x66: Run
- 0x67: Swimming

